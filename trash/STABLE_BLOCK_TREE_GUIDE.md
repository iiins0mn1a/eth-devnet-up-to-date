# 稳定区块树可视化使用指南

## 🎯 新功能概览

根据您的需求，区块树可视化器现在支持：

1. **🔒 稳定的区块树显示** - 不会频繁重新绘制
2. **🔄 手动刷新控制** - 用户主动选择何时更新
3. **🎛️ 节点选择器** - 可以查看不同beacon节点的区块树

## 🚀 功能特性

### 1. 稳定的布局算法
- **更慢的布局衰减**：避免频繁的位置调整
- **减少震荡**：更高的速度衰减参数
- **智能停止**：切换时停止之前的物理模拟

### 2. 手动刷新模式
- **默认关闭自动刷新**：启动时不会自动更新可视化
- **手动触发更新**：点击"🔄 手动刷新"按钮更新数据
- **防重复刷新**：刷新过程中按钮会被禁用

### 3. 节点选择功能
- **所有节点**：显示第一个可用节点的数据（默认）
- **Beacon-1到4**：选择特定节点查看其区块树视图
- **实时切换**：切换节点后立即显示对应的区块树

## 🎮 操作指南

### 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│                    🌐 以太坊测试网区块树可视化                      │
├─────────────────────────────────────────────────────────────┤
│  [槽位] [最终化Epoch] [确认Epoch] [连接数] [最后更新]              │
├─────────────────────────────────────────────────────────────┤
│  [选择节点: ▼] [🔄 手动刷新] [自动刷新: ○──●]                    │
├──────────────┬──────────────────────────────────────────────┤
│              │                                              │
│   区块列表    │              区块树可视化                      │
│              │                                              │
│  ┌─ Slot 16  │         ⚪ ← ⚪ ← ⚪                          │
│  ├─ Slot 15  │            ↑                                │
│  ├─ Slot 14  │         ⚪ ← ⚪                              │
│  └─ ...      │                                              │
└──────────────┴──────────────────────────────────────────────┘
```

### 控制选项详解

#### 🎛️ 节点选择器
```
选择节点: [所有节点 ▼]
         ├─ 所有节点 (默认，使用第一个可用节点)
         ├─ Beacon-1 (beacon-chain-1:7777)
         ├─ Beacon-2 (beacon-chain-2:7777)
         ├─ Beacon-3 (beacon-chain-3:7777)
         └─ Beacon-4 (beacon-chain-4:7777)
```

**用途**：
- 比较不同节点的区块树视图
- 检查节点间的数据一致性
- 诊断特定节点的分叉情况

#### 🔄 手动刷新按钮
```
[🔄 手动刷新] → 点击更新 → [🔄 刷新中...] → [🔄 手动刷新]
     ↑                           ↑                  ↑
   可点击状态                  禁用状态             恢复状态
```

**功能**：
- 更新当前选择节点的区块树数据
- 刷新状态栏和节点列表信息
- 更新"最后更新"时间戳

#### 🎚️ 自动刷新开关
```
自动刷新: [○────●]  →  点击切换  →  [●────○]
         关闭状态                    开启状态
```

**模式说明**：
- **关闭（默认）**：只在用户手动刷新时更新可视化
- **开启**：接收到新数据时自动更新可视化

## 📊 使用场景

### 1. 稳定观察模式
```bash
# 启动测试网
./main.sh

# 打开区块树可视化
http://localhost:8888

# 操作步骤：
1. 保持自动刷新关闭（默认）
2. 选择要观察的节点
3. 按需点击手动刷新
4. 稳定观察区块树结构
```

### 2. 节点对比模式
```bash
# 对比不同节点的区块树：
1. 选择 "Beacon-1" → 观察其区块树 → 截图/记录
2. 选择 "Beacon-2" → 观察其区块树 → 截图/记录
3. 选择 "Beacon-3" → 观察其区块树 → 截图/记录
4. 选择 "Beacon-4" → 观察其区块树 → 截图/记录
5. 比较差异，分析分叉情况
```

### 3. 实时监控模式
```bash
# 需要实时更新时：
1. 开启自动刷新开关
2. 选择主要观察的节点
3. 区块树会自动更新显示最新状态
```

## 🔧 技术实现

### 稳定性优化
```javascript
// 更稳定的力导向图参数
this.simulation = d3.forceSimulation(this.nodes)
    .force('link', d3.forceLink(this.links).distance(100))    // 增大连接距离
    .force('charge', d3.forceManyBody().strength(-300))       // 增强排斥力
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collision', d3.forceCollide().radius(20))         // 增大碰撞半径
    .alphaDecay(0.01)    // 更慢的衰减，更稳定的布局
    .velocityDecay(0.3); // 更高的速度衰减，减少震荡
```

### 手动刷新逻辑
```javascript
handleWebSocketMessage(message) {
    // 存储最新数据
    this.data = message.data;
    
    // 只在自动刷新模式下或者是初始数据时更新可视化
    if (this.autoRefresh || message.type === 'initial_data') {
        this.updateVisualization();
        // ...
    }
}
```

### 节点选择逻辑
```javascript
updateVisualization() {
    let selectedData;
    
    if (this.currentEndpoint === 'all') {
        selectedData = Object.values(this.data)[0];  // 第一个可用节点
    } else {
        const fullEndpoint = `http://${this.currentEndpoint}`;
        selectedData = this.data[fullEndpoint];      // 指定节点
    }
    
    this.processData(selectedData);
    this.renderTree();
}
```

## 🎯 最佳实践

### 1. 分叉分析工作流
```
1. 关闭自动刷新
2. 选择 "所有节点" 查看整体情况
3. 发现异常时，逐个选择节点查看
4. 使用手动刷新获取最新状态
5. 对比不同节点的区块树差异
```

### 2. 性能监控工作流
```
1. 开启自动刷新
2. 选择主要监控的节点
3. 观察区块生产频率
4. 监控最终化进程
5. 关注分叉事件
```

### 3. 问题排查工作流
```
1. 关闭自动刷新（避免干扰）
2. 收集所有节点的当前状态
3. 手动刷新获取最新数据
4. 逐个分析每个节点的区块树
5. 识别分叉点和异常节点
```

## 🐛 故障排除

### 常见问题

1. **区块树不更新**
   - 检查是否关闭了自动刷新
   - 点击手动刷新按钮
   - 确认WebSocket连接正常

2. **节点切换无效果**
   - 确认选择的节点正在运行
   - 检查节点是否有数据
   - 尝试刷新页面

3. **区块树布局混乱**
   - 刷新页面重置布局
   - 检查浏览器控制台错误
   - 尝试选择其他节点

### 调试信息
```javascript
// 浏览器控制台会显示：
console.log('收到WebSocket消息:', message.type);
console.log('自动刷新模式:', this.autoRefresh ? '开启' : '关闭');
console.log(`处理了 ${this.nodes.length} 个节点和 ${this.links.length} 个连接`);
```

## 📋 功能对比

| 功能 | 原版本 | 新版本 |
|------|--------|--------|
| **刷新模式** | 自动刷新 | 手动刷新（默认） |
| **布局稳定性** | 频繁重绘 | 稳定布局 |
| **节点选择** | 固定第一个 | 可选择任意节点 |
| **用户控制** | 无 | 完全控制 |
| **适用场景** | 实时监控 | 深度分析 |

现在您可以更精确地控制区块树的显示，进行稳定的观察和深入的分析！🎯
